---
title: 杜老师说的内网穿透思路与实践
tags:
  - 内网
categories:
  - 网络教程
date: 2022-10-16 00:00:00
---

> 应 MrZeFr 小朋友的需求，更新一篇关于杜老师如何实现家用服务器实现内网穿透教程，其中包含思路与实践的方法，希望可以对有需求的小伙伴提供借鉴参考。

<!-- more -->

## 写在前面

杜老师说之前部署在凉心云 Webify 上，前段时间因为受到攻击，导致账户直接欠费 1200 多「账户余额 0.23 元」

杜老师选择弃号改为本地服务器部署。因本地家用网络限制，不开放 80 端口，所以需要通过内网穿透、端口映射等技术手段实现网站的呈现。

## 网络拓扑

下面简单看下网络拓扑：

{% gallery %}
![](https://cdn.dusays.com/2022/10/515-1.jpg)
{% endgallery %}

## 穿透思路

1. 用户访问杜老师说；

2. 通过网络将请求转发给前端的 CDN；

3. CDN 通过 DDNS 指定端口回源；

4. DDNS 解析的公网地址经由光猫处理转发路由；

5. 路由器查询端口映射表，将请求数据转发服务器；

6. 服务器将处理好的数据发给路由；

7. 路由器将数据交给光猫发出；

8. CDN 获得回源数据在本地保留缓存；

9. 并同时将数据经由网络发给用户；

10. 用户收到数据在本地浏览器呈现网站内容。

## 穿透实践

首先查询当前宽带所在的服务商，比如杜老师是联通。

然后查询外网 IP 的种类，如果是城域网，则需要致电客服询问如何获取公网 IP「联通、电信一般说明按照监控，或是搭建本地存储即可；移动好像需要付费才行」

接下来是路由，为了有更好的映射效果，墙裂建议将光猫调整为桥接模式，使用路由拨号上网，然后通过路由中 DMZ 映射后端服务设备。

因为每次拨号都会分配不同地址，还需在服务端或路由器上开启 DDNS，这样 IP 发生变动时，可以自动调整域名解析。

## 知识拓展

上诉方法确切来说属于端口映射，将服务器端口映射到路由器，然后通过公网 IP 来调用；

如果是纯内网穿透「具体概念，可以参考《[何为内网穿透](https://dusays.com/250/)》一文」需搭建外网映射服务器。

这里推荐下 [NATAPP](https://natapp.cn)，使用优惠码 `2DE16A7D` 可九折购买相关的服务。

另外可以参考教程《[natapp 树莓派开机启动脚本](https://dusays.com/253/)》一文，进行本地配置。

## 写在最后

1. 因宽带商限制 80 端口的访问，如果搭建网站，还是需要 CDN 回源或内网穿透，不然只能手动指定非 80 端口「好像 443 也不行」

2. DMZ 的端口映射模式，是将路由所有端口与服务器一一对应，这样会降低安全性，建议只做所需要的端口映射。